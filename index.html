<!DOCTYPE html>
<html lang="fa" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clean IP Scanner - Modern & Fast">
    <title data-translate="page-title">IP Scanner</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Vazirmatn for Persian, Inter for English) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            /* Custom Theme Colors */
            --primary-gold: #C7A46C;
            --primary-gold-hover: #b08b55;
            --bg-dark: #1E1E1E;
            --bg-card: rgba(40, 40, 40, 0.6);
            --bg-glass: rgba(30, 30, 30, 0.4);
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --border-color: rgba(199, 164, 108, 0.2);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --shadow-soft: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(199, 164, 108, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(199, 164, 108, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: 'Inter', 'Vazirmatn', sans-serif;
            min-height: 100vh;
            padding-top: 80px;
            transition: all 0.3s ease;
        }

        /* Glassmorphism Components */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
        }

        /* Navbar */
        .navbar {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            transition: all 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-gold) !important;
            letter-spacing: 0.5px;
        }

        /* Controls & Inputs */
        .form-control, .form-select {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-radius: 12px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        /* Force LTR for inputs to handle IPs and numbers correctly in RTL modes */
        .form-control, .form-select, .ltr-text {
            direction: ltr !important;
            text-align: left;
            unicode-bidi: embed;
            font-family: 'Inter', 'Vazirmatn', sans-serif; /* Prefer Inter for numbers */
        }

        [dir="rtl"] .ltr-text {
            text-align: right;
        }

        .form-control:focus, .form-select:focus {
            background-color: rgba(0, 0, 0, 0.5);
            border-color: var(--primary-gold);
            color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(199, 164, 108, 0.25);
        }

        .form-floating > label {
            color: var(--text-muted);
            text-align: left; /* Keep label left in LTR mode */
        }
        
        [dir="rtl"] .form-floating > label {
            text-align: right; /* Align label right in RTL mode */
        }

        /* Buttons */
        .btn-gold {
            background-color: var(--primary-gold);
            border: none;
            color: #1E1E1E;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .btn-gold:hover {
            background-color: var(--primary-gold-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(199, 164, 108, 0.3);
            color: #1E1E1E;
        }

        .btn-outline-gold {
            border: 1px solid var(--primary-gold);
            color: var(--primary-gold);
            border-radius: 12px;
        }

        .btn-outline-gold:hover, .btn-outline-gold.active {
            background-color: rgba(199, 164, 108, 0.1);
            color: var(--primary-gold);
        }

        /* Accordion (Advanced Settings) */
        .accordion-item {
            background-color: transparent;
            border: 1px solid rgba(199, 164, 108, 0.15);
            border-radius: 12px !important;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-button {
            background-color: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-weight: 500;
            box-shadow: none;
        }

        .accordion-button:not(.collapsed) {
            background-color: rgba(199, 164, 108, 0.08);
            color: var(--primary-gold);
            box-shadow: none;
        }

        .accordion-button::after {
            filter: invert(1); /* Make arrow white/gold compatible */
        }
        
        .accordion-button:not(.collapsed)::after {
            filter: none; /* Default color */
        }

        .accordion-body {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-main);
        }

        /* Table */
        .table-custom {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            color: var(--text-main);
        }

        .table-custom th {
            background-color: rgba(199, 164, 108, 0.1);
            color: var(--primary-gold);
            font-weight: 600;
            border: none;
            padding: 15px;
            text-align: center;
        }
        
        .table-custom td {
            background-color: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px;
            vertical-align: middle;
            text-align: center;
        }

        .table-custom tr:hover td {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* Status Indicators */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1E1E1E; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-gold); 
        }

        /* RTL Specifics */
        [dir="rtl"] .dropdown-menu {
            right: 0;
            left: auto;
            text-align: right;
        }

        /* Utility */
        .text-gold { color: var(--primary-gold) !important; }
        .border-gold { border-color: var(--primary-gold) !important; }
        
        /* Loading Spinner */
        .spinner-border-gold {
            --bs-spinner-color: var(--primary-gold);
        }

        .alert-custom {
            border: 1px solid rgba(199, 164, 108, 0.3);
            background: rgba(199, 164, 108, 0.1);
            color: #fff;
        }
    </style>
</head>

<body data-bs-theme="dark">

    <!-- Navigation -->
    <nav class="navbar fixed-top navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-radar"></i> <span data-translate="header-text">IP Scanner</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="bi bi-list text-gold" style="font-size: 1.5rem;"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center gap-3">
                    
                    <!-- Theme Toggle -->
                    <li class="nav-item">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" onclick="toggleTheme()" checked>
                            <label class="form-check-label text-gold ms-2" for="flexSwitchCheckChecked" data-translate="darkmode"></label>
                        </div>
                    </li>

                    <!-- Language Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle btn btn-outline-gold px-3" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe"></i> <small data-translate="language">Language</small>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark glass-panel">
                            <li><a class="dropdown-item" onclick="changeLanguage('en')">English üá¨üáß</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('de')">Deutsch üá©üá™</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('fa')">ŸÅÿßÿ±ÿ≥€å üáÆüá∑</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('fr')">Fran√ßaise üá´üá∑</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('tr')">T√ºrk√ße üáπüá∑</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('es')">Espa√±ol üá™üá∏</a></li>
                            <li><a class="dropdown-item" onclick="changeLanguage('zh')">‰∏≠Êñá üá®üá≥</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mb-5">
        
        <!-- Introduction Card -->
        <div class="glass-panel p-4 mb-4 fade-in-up">
            <h3 class="text-gold mb-2"><i class="bi bi-shield-check"></i> <span data-translate="clean-ip-scanner">Clean IP Scanner</span></h3>
            <p class="text-muted mb-0" data-translate="description">
                Safe and clean IP for Cloudflare to access free internet.
            </p>
        </div>

        <!-- Alerts -->
        <div id="status-alert" class="alert alert-custom d-flex align-items-center d-none" role="alert">
            <i class="bi bi-info-circle-fill text-gold me-2 fs-4"></i>
            <div data-translate="defAlert">With IP Scanner tool, you can search for clean Cloudflare IPs!</div>
        </div>

        <div class="alert alert-danger d-flex align-items-center glass-panel" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
            <div data-translate="dangAlert">Before you start, turn off your VPN!</div>
        </div>

        <!-- Settings Panel -->
        <div class="glass-panel p-4 mb-4">
            <div class="row g-3">
                <!-- IP Count -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input class="form-control ltr-text" type="number" id="max-ip" min="1" max="5000" value="20" placeholder="IP Count">
                        <label for="max-ip" data-translate="ip-count">Number of IPs</label>
                    </div>
                </div>
                <!-- Max Latency -->
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="number" class="form-control ltr-text" id="max-latency" min="50" max="3000" step="50" value="400" placeholder="Max Latency">
                        <label for="max-latency" data-translate="max-latency">Maximum Latency</label>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Accordion -->
            <div class="accordion mt-4" id="accordionAdvanced">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced" aria-expanded="true" aria-controls="collapseAdvanced">
                            <i class="bi bi-sliders me-2"></i> Advanced Settings
                        </button>
                    </h2>
                    <div id="collapseAdvanced" class="accordion-collapse collapse show" data-bs-parent="#accordionAdvanced">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <!-- Include Range -->
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input class="form-control ltr-text" type="text" id="ip-include" placeholder="Include Ranges">
                                        <label for="ip-include" data-translate="include-range">Ranges to include</label>
                                    </div>
                                </div>
                                <!-- Exclude Range -->
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control ltr-text" id="ip-exclude" placeholder="Exclude Ranges">
                                        <label for="ip-exclude" data-translate="exclude-range">Ranges to exclude</label>
                                    </div>
                                </div>
                                <!-- Regex -->
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input class="form-control ltr-text" type="text" id="ip-regex" placeholder="Regular Expression">
                                        <label for="ip-regex" data-translate="expressions">Regular expression</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                <button class="btn btn-gold btn-lg px-5" type="button" id="btn-start" onclick="startScan()" disabled>
                    <i class="bi bi-play-fill"></i> <span data-translate="start">Start</span>
                </button>
                <button class="btn btn-danger btn-lg px-5" type="button" id="btn-cancel" onclick="cancelScan()" disabled>
                    <i class="bi bi-stop-fill"></i> <span data-translate="stop">Stop</span>
                </button>
            </div>
        </div>

        <!-- Live Status (Initially Hidden) -->
        <div id="live-status" class="glass-panel p-3 mb-4 d-none">
            <div class="row align-items-center text-center">
                <div class="col-md-3">
                    <small class="text-muted d-block" data-translate="tools">Status</small>
                    <span id="test-no" class="fw-bold text-gold">Ready</span>
                </div>
                <div class="col-md-6">
                    <div class="progress mt-2" style="height: 6px; background: rgba(255,255,255,0.1);">
                        <div id="progress-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-white"><span id="ip-no" class="ltr-text d-inline-block">--</span> <span id="ip-try" class="ms-2 text-muted"></span></small>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block" data-translate="latency">Latency</small>
                    <span id="ip-latency" class="fw-bold ltr-text d-inline-block">--</span>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="glass-panel p-0 overflow-hidden d-none" id="TableForm">
            <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                <h5 class="m-0 text-gold"><i class="bi bi-list-ol"></i> Results (Sorted by Ping)</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-light" onclick="downloadAsCSV()" title="Download CSV">
                        <i class="bi bi-filetype-csv"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="downloadAsJSON()" title="Download JSON">
                        <i class="bi bi-filetype-json"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="copyAllToClipboard()" title="Copy All">
                        <i class="bi bi-clipboard-data"></i>
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th style="min-width: 140px;" data-translate="ip">IP Address</th>
                            <th data-translate="latency">Latency (Ping)</th>
                            <th width="100">Action</th>
                        </tr>
                    </thead>
                    <tbody id="result">
                        <!-- Rows inserted by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="text-center py-4 mt-5 border-top border-secondary">
        <p class="text-muted mb-1" data-translate="footer-text">¬© By DrunkLeen</p>
        <a href="https://github.com/drunkleen" target="_blank" class="text-gold text-decoration-none">
            <i class="bi bi-github"></i> GitHub
        </a>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Application Logic -->
    <script>
        // --- Configuration & State ---
        var cfIPv4 = [];
        var cfIPv4ToScan = [];
        const noOfEachRange24 = 30;
        
        // UI Elements
        let maxIPInput = document.getElementById('max-ip');
        let maxLatencyInput = document.getElementById('max-latency');
        let ipRegexInput = document.getElementById('ip-regex');
        let ipIncludeInput = document.getElementById('ip-include');
        let ipExcludeInput = document.getElementById('ip-exclude');
        let btnStart = document.getElementById('btn-start');
        let btnCancel = document.getElementById('btn-cancel');
        let resultTableBody = document.getElementById('result');
        let statusAlert = document.getElementById('status-alert');
        let liveStatus = document.getElementById('live-status');
        let tableForm = document.getElementById('TableForm');

        // State variables
        let maxIP;
        let testNo;
        let validIPs = [];
        let maxLatency;
        let numberOfWorkingIPs;
        let ipRegex;
        let ipInclude;
        let ipExclude;
        let immediateStop = false;
        let progressBar = document.getElementById('progress-bar');
        let language = localStorage.getItem('lang') || 'en';

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            // Restore saved values
            maxIPInput.value = localStorage.getItem('max-ip') || 20;
            maxLatencyInput.value = localStorage.getItem('max-latency') || 400;
            ipRegexInput.value = localStorage.getItem('ip-regex') || '';
            ipIncludeInput.value = localStorage.getItem('ip-include') || '';
            ipExcludeInput.value = localStorage.getItem('ip-exclude') || '';

            // Show alert after a small delay
            setTimeout(() => statusAlert.classList.remove('d-none'), 500);

            // Load IP Ranges
            loadIPRanges();
            
            // Set Initial Language Direction
            changeLanguage(language);
        });

        function loadIPRanges() {
            const client = new XMLHttpRequest();
            client.open('GET', './assets/ipv4.txt');
            client.onreadystatechange = function () {
                if (client.readyState === 4) {
                    if (client.status === 200) {
                        cfIPv4 = client.responseText.split("\n").map((cidr) => cidr.trim()).filter((cidr) => isCIDR(cidr));
                        btnStart.disabled = false;
                        btnStart.innerHTML = `<i class="bi bi-play-fill"></i> <span data-translate="start">${translations[language]['start']}</span>`;
                        console.log(`Loaded ${cfIPv4.length} CIDR ranges.`);
                    } else {
                        statusAlert.className = "alert alert-danger d-flex align-items-center glass-panel mt-3";
                        statusAlert.innerHTML = `<i class="bi bi-exclamation-octagon-fill me-2"></i> Error loading assets/ipv4.txt. Please ensure file exists.`;
                    }
                }
            };
            client.send();
        }

        // --- Core Functions ---

        function startScan() {
            // UI Updates
            liveStatus.classList.remove('d-none');
            tableForm.classList.remove('d-none');
            statusAlert.classList.add('d-none');

            // Get Values
            maxIP = ~~maxIPInput.value;
            maxLatency = ~~maxLatencyInput.value;
            ipRegex = ipRegexInput.value;
            ipInclude = ipIncludeInput.value;
            ipExclude = ipExcludeInput.value;

            // Save Values
            localStorage.setItem('max-ip', maxIP);
            localStorage.setItem('max-latency', maxLatency);
            localStorage.setItem('ip-regex', ipRegex);
            localStorage.setItem('ip-include', ipInclude);
            localStorage.setItem('ip-exclude', ipExclude);

            // Reset State
            testNo = 0;
            numberOfWorkingIPs = 0;
            validIPs = [];
            resultTableBody.innerHTML = '';
            immediateStop = false;
            progressBar.style.width = '0%';

            // Toggle Buttons
            btnStart.disabled = true;
            btnCancel.disabled = false;
            
            // Disable Inputs
            [maxIPInput, maxLatencyInput, ipRegexInput, ipIncludeInput, ipExcludeInput].forEach(el => el.disabled = true);

            document.getElementById('test-no').innerText = "Initializing...";
            document.getElementById('ip-no').innerText = "--";

            setTimeout(() => {
                let ips = processIPs();
                ips = randomizeElements(ips);
                testIPs(ips);
            }, 100);
        }

        function cancelScan() {
            immediateStop = true;
            resetUIState();
            document.getElementById('test-no').innerHTML = '<span class="text-danger">Canceled</span>';
        }

        function resetUIState() {
            btnStart.disabled = false;
            btnCancel.disabled = true;
            [maxIPInput, maxLatencyInput, ipRegexInput, ipIncludeInput, ipExcludeInput].forEach(el => el.disabled = false);
            document.getElementById('test-no').innerText = "Ready";
            document.getElementById('ip-no').innerText = "--";
            document.getElementById('ip-try').innerText = "";
            document.getElementById('ip-latency').innerText = "--";
            progressBar.style.width = '0%';
        }

        function processIPs() {
            let ips = [];
            let regex = null;
            let excludeRegex = null;

            if (ipRegex) {
                regex = new RegExp(ipRegex);
            }

            if (ipInclude) {
                cfIPv4ToScan = makeCIDR(ipInclude);
            } else {
                cfIPv4ToScan = [...cfIPv4];
            }

            if (ipExclude) {
                excludeRegex = new RegExp(
                    ipExclude.split(',').map(c => { return '^' + c.replaceAll('.', '\\.').replaceAll('/', '\\/') }).join('|')
                );
            }

            for (const cidr of cfIPv4ToScan) {
                if (regex && !regex.test(cidr)) continue;
                if (excludeRegex && excludeRegex.test(cidr)) continue;
                ips = ips.concat(cidrToRandomIPArray(cidr));
            }
            return ips;
        }

        async function testIPs(ipList) {
            for (const ip of ipList) {
                if (immediateStop) break;

                testNo++;
                var testResult = 0;
                const url = `https://${ip}:2096/__down`;
                const startTime = performance.now();
                const controller = new AbortController();
                
                // Dynamic Timeout Calculation
                const multiply = maxLatency <= 500 ? 1.5 : (maxLatency <= 1000 ? 1.2 : 1);
                var timeout = 1.5 * multiply * maxLatency;
                var chNo = 0;

                // Visual Update
                document.getElementById('test-no').innerText = `#${testNo}`;
                document.getElementById('ip-no').innerText = ip;
                document.getElementById('ip-no').className = "fw-bold text-warning";

                for (const ch of ['', '|', '/', '-', '\\']) {
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    if (ch) {
                        timeout = 1 * multiply * maxLatency;
                        document.getElementById('ip-try').innerText = ch;
                    } else {
                        timeout = 1.2 * multiply * maxLatency;
                        document.getElementById('ip-try').innerText = '';
                    }

                    try {
                        await fetch(url, { signal: controller.signal, mode: 'no-cors' }); 
                        testResult++;
                    } catch (error) {
                        if (error.name !== "AbortError") {
                            testResult++; 
                        }
                    }
                    clearTimeout(timeoutId);
                    chNo++;
                }

                const latency = Math.floor((performance.now() - startTime) / 5);
                document.getElementById('ip-latency').innerText = `${latency}ms`;
                
                // Fake progress
                if(testNo % 5 === 0) {
                    progressBar.style.width = Math.min((numberOfWorkingIPs / maxIP) * 100, 100) + '%';
                }

                if (testResult >= 3 && latency <= maxLatency) {
                    numberOfWorkingIPs++;
                    validIPs.push({ ip: ip, latency: latency });
                    
                    // Sorting: Always sort by latency (ascending) before rendering
                    const sortedArr = [...validIPs].sort((a, b) => a.latency - b.latency);

                    const tableRows = sortedArr.map((obj, index) => `
                        <tr>
                            <td><span class="badge bg-secondary">${index + 1}</span></td>
                            <td class="text-gold fw-mono ltr-text">${obj.ip}</td>
                            <td class="ltr-text">${obj.latency}ms</td>
                            <td>
                                <button class="btn btn-sm btn-outline-gold" onclick="copyToClipboard('${obj.ip}')" title="Copy">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </td>
                        </tr>`).join('');

                    resultTableBody.innerHTML = tableRows;

                    if (numberOfWorkingIPs >= maxIP) {
                        break;
                    }
                }
            }

            resetUIState();

            if (immediateStop) {
                immediateStop = false;
                statusAlert.className = "alert alert-danger d-flex align-items-center glass-panel mt-3 d-block";
                statusAlert.innerHTML = `<i class="bi bi-x-circle-fill me-2"></i> ${translations[language]['canceled']}`;
            } else {
                // Post results to parent window if embedded
                if (window.self !== window.top) {
                    window.top.postMessage(validIPs.map(el => el.ip).join('\n'), '*');
                }
                
                statusAlert.className = "alert alert-success d-flex align-items-center glass-panel mt-3 d-block";
                statusAlert.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> ${translations[language]['done']}`;
                progressBar.style.width = '100%';
            }
        }

        // --- Utilities ---

        function copyToClipboard(ip) {
            window.navigator.clipboard.writeText(ip).then(() => {
                const btn = event.currentTarget;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="bi bi-check-lg"></i>`;
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                }, 1500);
            });
        }

        function copyAllToClipboard() {
            const txt = validIPs.map(el => el.ip).join('\n');
            window.navigator.clipboard.writeText(txt);
        }

        function downloadAsCSV() {
            const csvString = validIPs.map(el => el.ip).join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'ip-list.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadAsJSON() {
            const jsonString = JSON.stringify(validIPs, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'ip-list.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function isCIDR(cidr) {
            return cidr.match(/^([0-9]{1,3}\.){3}[0-9]{1,3}\/(16|17|18|19|20|21|22|23|24)$/g);
        }

        function makeCIDR(includeStr) {
            let includeList = includeStr.split(',').map((cidr) => cidr.trim());
            cidrList = includeList.flatMap((cidr) => {
                if (isCIDR(cidr)) return [cidr];
                else if (cidr) {
                    const regex = new RegExp('^' + cidr.replaceAll('.', '\\.').replaceAll('/', '\\\/'));
                    return cfIPv4.filter((cidr) => cidr.match(regex));
                } else return [];
            })
            return cidrList;
        }

        function generateRandomNumbers(count) {
            const numbers = [];
            while (numbers.length < count) {
                const randomNumber = Math.floor(Math.random() * 254) + 1;
                if (!numbers.includes(randomNumber)) numbers.push(randomNumber);
            }
            return numbers;
        }

        function splitCIDRTo24Ranges(cidr) {
            const [baseIP, baseMask] = cidr.split('/');
            const baseStart = baseIP.split('.').reduce((acc, octet) => (acc << 8) | parseInt(octet, 10), 0) >>> 0;
            const baseEnd = (baseStart | (0xffffffff >>> parseInt(baseMask, 10))) >>> 0;
            const ranges = [];
            let currentStart = baseStart;
            while (currentStart <= baseEnd) {
                ranges.push(currentStart);
                currentStart += 0x100;
            }
            return ranges;
        }

        function cidrToRandomIPArray(cidr) {
            const ranges = splitCIDRTo24Ranges(cidr);
            const ips = [];
            for (const start of ranges) {
                const prefix = `${(start >>> 24) & 0xff}.${(start >>> 16) & 0xff}.${(start >>> 8) & 0xff}`;
                for (const no of generateRandomNumbers(noOfEachRange24)) {
                    ips.push(prefix + '.' + no);
                }
            }
            return ips;
        }

        function randomizeElements(arr) {
            return [...arr].sort(() => { return 0.5 - Math.random() });
        }

        // --- Localization & Theme ---

        const translations = {
            'de': { 'direction': 'ltr', "darkmode": "Dunkelmodus", 'clean-ip-scanner': 'Clean IP Scanner', 'language': 'Sprache', "page-title": "leen | IP Scanner", "defAlert": "Mit dem IP-Scanner-Tool k√∂nnen Sie nach sauberen Cloudflare-IPs suchen!", "header-text": "Freies Internet ist ein Menschenrecht | Frauen Leben Freiheit", "description": "Sichere und saubere IP f√ºr Cloudflare, um auf das kostenlose Internet zuzugreifen", "tools": "Werkzeuge", "ip-count": "Anzahl der IPs", "max-latency": "Maximale Latenz", "include-range": "Bereiche zum Einbeziehen", "exclude-range": "Bereiche zum Ausschlie√üen", "expressions": "Regul√§rer Ausdruck", "dangAlert": "Bevor Sie beginnen, schalten Sie Ihr VPN aus!", "start": "Starten", "stop": "Stoppen", "done": "IP-Suche abgeschlossen!", "canceled": "IP-Suche abgebrochen!", "about": "√úber", "ip": "IP", 'latency': 'Latenz', "footer-text": "¬© bei DrunkLeen" },
            'en': { 'direction': 'ltr', "darkmode": "Dark Mode", 'clean-ip-scanner': 'Clean IP Scanner', 'language': 'Language', "page-title": "leen | IP Scanner", "defAlert": "With IP Scanner tool, you can search for clean Cloudflare IPs!", "header-text": "Free internet is a human right | Women Life Freedom", "description": "Safe and clean IP for Cloudflare to access to free internet", "tools": "Tools", "ip-count": "Number of IPs", "max-latency": "Maximum Latency", "include-range": "Ranges to include", "exclude-range": "Ranges to exclude", "expressions": "Regular expression", "dangAlert": "Before you start, turn off your VPN!", "start": "Start", "stop": "Stop", "done": "Searching IP finished!", "canceled": "Searching IP canceled!", "about": "About", "ip": "IP", 'latency': 'Latency', "footer-text": "¬© By DrunkLeen" },
            'fa': { 'direction': 'rtl', "darkmode": "ÿ≠ÿßŸÑÿ™ ÿ™ÿßÿ±€å⁄©", 'clean-ip-scanner': 'ÿßÿ≥⁄©ŸÜÿ± IP ÿ™ŸÖ€åÿ≤', 'language': 'ÿ≤ÿ®ÿßŸÜ', "page-title": "leen | ÿßÿ≥⁄©ŸÜ IP", "defAlert": "ÿ®ÿß ÿßÿ®ÿ≤ÿßÿ± ÿßÿ≥⁄©ŸÜ IP ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ®ÿ±ÿß€å IP‚ÄåŸáÿß€å ÿ™ŸÖ€åÿ≤ Cloudflare ÿ¨ÿ≥ÿ™ÿ¨Ÿà ⁄©ŸÜ€åÿØ!", "header-text": "ÿß€åŸÜÿ™ÿ±ŸÜÿ™ ÿ¢ÿ≤ÿßÿØ ÿ≠ŸÇ ÿßŸÜÿ≥ÿßŸÜ€åÿ≥ÿ™ | ÿ≤ŸÜ ÿ≤ŸÜÿØ⁄Ø€å ÿ¢ÿ≤ÿßÿØ€å", "description": "IP ÿßŸÖŸÜ Ÿà ÿ™ŸÖ€åÿ≤ ÿ®ÿ±ÿß€å ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿ®Ÿá ÿß€åŸÜÿ™ÿ±ŸÜÿ™ ÿ¢ÿ≤ÿßÿØ ÿßÿ≤ ÿ∑ÿ±€åŸÇ Cloudflare", "tools": "ÿßÿ®ÿ≤ÿßÿ±Ÿáÿß", "ip-count": "ÿ™ÿπÿØÿßÿØ IP‚ÄåŸáÿß", "max-latency": "ÿ≠ÿØÿß⁄©ÿ´ÿ± ÿ™ÿßÿÆ€åÿ±", "include-range": "ŸÖÿ≠ÿØŸàÿØŸá‚ÄåŸáÿß€å ŸÇÿßÿ®ŸÑ ÿ™ÿ∂ŸÖ€åŸÜ", "exclude-range": "ŸÖÿ≠ÿØŸàÿØŸá‚ÄåŸáÿß€å ŸÖÿ≥ÿ™ÿ´ŸÜ€å", "expressions": "ÿπÿ®ÿßÿ±ÿ™ ŸÖŸÜÿ∏ŸÖ", "dangAlert": "ŸÇÿ®ŸÑ ÿßÿ≤ ÿ¥ÿ±Ÿàÿπÿå VPN ÿÆŸàÿØ ÿ±ÿß ÿÆÿßŸÖŸàÿ¥ ⁄©ŸÜ€åÿØ!", "start": "ÿ¥ÿ±Ÿàÿπ", "stop": "ÿ™ŸàŸÇŸÅ", "done": "ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å IP ÿ®Ÿá ÿßÿ™ŸÖÿßŸÖ ÿ±ÿ≥€åÿØ!", "canceled": "ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å IP ŸÑÿ∫Ÿà ÿ¥ÿØ!", "about": "ÿØÿ±ÿ®ÿßÿ±Ÿá", "ip": "IP", 'latency': 'ÿ™ÿßÿÆ€åÿ±', "footer-text": "¬© ÿ™Ÿàÿ≥ÿ∑ DrunkLeen" },
            'fr': { 'direction': 'ltr', "darkmode": "Mode sombre", 'clean-ip-scanner': 'Scanner IP propre', 'language': 'Langue', "page-title": "leen | Scanner IP", "defAlert": "Avec l'outil de scanner IP, vous pouvez rechercher des IP propres √† Cloudflare!", "header-text": "Internet gratuit est un droit humain | Femmes Vie Libert√©", "description": "IP s√ªre et propre pour acc√©der √† Internet gratuitement via Cloudflare", "tools": "Outils", "ip-count": "Nombre d'IP", "max-latency": "Latence maximale", "include-range": "Plages √† inclure", "exclude-range": "Plages √† exclure", "expressions": "Expression r√©guli√®re", "dangAlert": "Avant de commencer, d√©sactivez votre VPN !", "start": "D√©marrer", "stop": "Arr√™ter", "done": "Recherche IP termin√©e !", "canceled": "Recherche IP annul√©e !", "about": "√Ä propos de", "ip": "IP", 'latency': 'Latence', "footer-text": "¬© Par DrunkLeen" },
            'ru': { 'direction': 'ltr', "darkmode": "–¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º", 'clean-ip-scanner': '–ß–∏—Å—Ç—ã–π IP-—Å–∫–∞–Ω–µ—Ä', 'language': '–Ø–∑—ã–∫', "page-title": "leen | IP Scanner", "defAlert": "–° –ø–æ–º–æ—â—å—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ IP Scanner –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–∫–∞—Ç—å —á–∏—Å—Ç—ã–µ IP-–∞–¥—Ä–µ—Å–∞ Cloudflare!", "header-text": "–°–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç - —ç—Ç–æ –ø—Ä–∞–≤–æ —á–µ–ª–æ–≤–µ–∫–∞ | –ñ–µ–Ω—â–∏–Ω—ã –ñ–∏–∑–Ω—å –°–≤–æ–±–æ–¥–∞", "description": "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —á–∏—Å—Ç—ã–π IP –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É —á–µ—Ä–µ–∑ Cloudflare", "tools": "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "ip-count": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ IP", "max-latency": "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞", "include-range": "–î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è", "exclude-range": "–î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è", "expressions": "–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ", "dangAlert": "–ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN!", "start": "–ù–∞—á–∞—Ç—å", "stop": "–°—Ç–æ–ø", "done": "–ü–æ–∏—Å–∫ IP –∑–∞–≤–µ—Ä—à—ë–Ω!", "canceled": "–ü–æ–∏—Å–∫ IP –æ—Ç–º–µ–Ω—ë–Ω!", "about": "–û –Ω–∞—Å", "ip": "IP", 'latency': '–ó–∞–¥–µ—Ä–∂–∫–∞', "footer-text": "¬© –û—Ç DrunkLeen" },
            'es': { 'direction': 'ltr', "darkmode": "Modo oscuro", 'clean-ip-scanner': 'Esc√°ner de IP limpio', 'language': 'Idioma', "page-title": "leen | Esc√°ner de IP", "defAlert": "Con la herramienta IP Scanner, ¬°puedes buscar IPs limpias de Cloudflare!", "header-text": "El internet libre es un derecho humano | Mujeres Vida Libertad", "description": "IP segura y limpia para que Cloudflare acceda al internet libre", "tools": "Herramientas", "ip-count": "N√∫mero de IPs", "max-latency": "Latencia m√°xima", "include-range": "Rangos a incluir", "exclude-range": "Rangos a excluir", "expressions": "Expresi√≥n regular", "dangAlert": "¬°Antes de comenzar, apaga tu VPN!", "start": "Comenzar", "stop": "Detener", "done": "¬°B√∫squeda de IP finalizada!", "canceled": "¬°B√∫squeda de IP cancelada!", "about": "Acerca de", "ip": "IP", 'latency': 'Latencia', "footer-text": "¬© Por DrunkLeen" },
            'tr': { 'direction': 'ltr', "darkmode": "Karanlƒ±k Mod", 'clean-ip-scanner': 'Temiz IP Tarayƒ±cƒ±', 'language': 'Dil', "page-title": "leen | IP Tarayƒ±cƒ±", "defAlert": "IP Tarayƒ±cƒ± aracƒ± ile temiz Cloudflare IP'lerini arayabilirsiniz!", "header-text": "√ñzg√ºr internet bir insan hakkƒ±dƒ±r | Kadƒ±nlar Hayat √ñzg√ºrl√ºk", "description": "√úcretsiz internete eri≈üim i√ßin g√ºvenli ve temiz IP", "tools": "Ara√ßlar", "ip-count": "IP Sayƒ±sƒ±", "max-latency": "Maksimum Gecikme", "include-range": "Dahil edilecek aralƒ±klar", "exclude-range": "Dƒ±≈ülanacak aralƒ±klar", "expressions": "D√ºzenli ifade", "dangAlert": "Ba≈ülamadan √∂nce VPN'inizi kapatƒ±n!", "start": "Ba≈ülat", "stop": "Durdur", "done": "IP arama tamamlandƒ±!", "canceled": "IP arama iptal edildi!", "about": "Hakkƒ±nda", "ip": "IP", 'latency': 'Gecikme', "footer-text": "¬© DrunkLeen tarafƒ±ndan" },
            'zh': { 'direction': 'ltr', "darkmode": "Ê∑±Ëâ≤Ê®°Âºè", 'clean-ip-scanner': 'Ê∏ÖÊ¥ÅIPÊâ´ÊèèÂô®', 'language': 'ËØ≠Ë®Ä', "page-title": "leen | IP Êâ´ÊèèÂô®", "defAlert": "‰ΩøÁî® IP Scanner Â∑•ÂÖ∑ÔºåÊÇ®ÂèØ‰ª•ÊêúÁ¥¢Âπ≤ÂáÄÁöÑ Cloudflare IP!", "header-text": "Ëá™Áî±‰∫íËÅîÁΩëÊòØ‰∫∫ÊùÉ | Â•≥ÊÄß ÁîüÊ¥ª Ëá™Áî±", "description": "Cloudflare ËÆøÈóÆËá™Áî±‰∫íËÅîÁΩëÊâÄÈúÄÁöÑÂÆâÂÖ®ËÄåÊ∏ÖÊ¥ÅÁöÑ IP", "tools": "Â∑•ÂÖ∑", "ip-count": "IP Êï∞Èáè", "max-latency": "ÊúÄÂ§ßÂª∂Ëøü", "include-range": "Ë¶ÅÂåÖÂê´ÁöÑËåÉÂõ¥", "exclude-range": "Ë¶ÅÊéíÈô§ÁöÑËåÉÂõ¥", "expressions": "Ê≠£ÂàôË°®ËææÂºè", "dangAlert": "ÂºÄÂßã‰πãÂâçÔºåËØ∑ÂÖ≥Èó≠ÊÇ®ÁöÑ VPNÔºÅ", "start": "ÂºÄÂßã", "stop": "ÂÅúÊ≠¢", "done": "IP ÊêúÁ¥¢ÂÆåÊàêÔºÅ", "canceled": "IP ÊêúÁ¥¢Â∑≤ÂèñÊ∂àÔºÅ", "about": "ÂÖ≥‰∫é", "ip": "IP", 'latency': 'Âª∂Ëøü', "footer-text": "¬© Áî±DrunkLeen" }
        };

        function changeLanguage(lang = 'en') {
            language = lang;
            localStorage.setItem('lang', lang);
            
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update Page Title
            if (translations[lang]['page-title']) {
                document.title = translations[lang]['page-title'];
            }

            // Handle Global Direction for Persian Numbers Fix
            const htmlTag = document.documentElement;
            const bodyTag = document.body;
            
            if (lang === 'fa') {
                htmlTag.setAttribute('dir', 'rtl');
                bodyTag.setAttribute('dir', 'rtl');
            } else {
                // Force LTR for non-Persian languages to prevent Persian numbers
                htmlTag.setAttribute('dir', 'ltr');
                bodyTag.setAttribute('dir', 'ltr');
            }
        }

        function toggleTheme() {
            const bodyElement = document.body;
            const currentTheme = bodyElement.getAttribute('data-bs-theme');
            const checkbox = document.getElementById("flexSwitchCheckChecked");
            
            if (currentTheme === 'dark') {
                bodyElement.setAttribute('data-bs-theme', 'light');
                bodyElement.style.backgroundColor = '#f0f0f0';
                bodyElement.style.color = '#333';
                localStorage.setItem('darkMode', 'light');
                checkbox.checked = false;
            } else {
                bodyElement.setAttribute('data-bs-theme', 'dark');
                bodyElement.style.backgroundColor = 'var(--bg-dark)';
                bodyElement.style.color = '#fff';
                localStorage.setItem('darkMode', 'dark');
                checkbox.checked = true;
            }
        }

        // Initialize Language (Run immediately to set direction)
        if (!localStorage.getItem('lang')) {
            changeLanguage('en');
        } else {
            changeLanguage(localStorage.getItem('lang'));
        }

    </script>
</body>
</html>
